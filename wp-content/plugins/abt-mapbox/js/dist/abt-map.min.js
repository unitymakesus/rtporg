function renderListings(features){if(listingEl.innerHTML="",features.sort(function(a,b){var keyA=decode_string(a.properties.title),keyB=decode_string(b.properties.title);return keyB>keyA?-1:keyA>keyB?1:0}),features.length)features.forEach(function(feature){var property=feature.properties,title=property.title?property.title:"",address1=property.address1?property.address1:"",address2=property.address2?property.address2:"",city="Research Triangle Park",state="NC",zipcode="27709";address1&&address2?address=address1+"<br />"+address2+"<br />"+city+" "+state+", "+zipcode:address1?address=address1+"<br />"+city+" "+state+", "+zipcode:address="";var item=document.createElement("article"),item_title=document.createElement("h1");item_title.className="entry-title",item_title.innerHTML=title;var item_address=document.createElement("div");item_address.className="adr",item_address.innerHTML=address,item.appendChild(item_title),item.appendChild(item_address),item.addEventListener("mouseover",function(){popup.setLngLat(feature.geometry.coordinates).setText(feature.properties.title).addTo(map)}),item.addEventListener("click",function(){map.flyTo({center:feature.geometry.coordinates,zoom:14,speed:1,curve:1})}),$("#feature-listing").append(item)}),filterEl.parentNode.style.display="block";else{var item=document.createElement("article");item.className="empty",item.textContent="Drag & zoom the map to find locations",$("#feature-listing").append(item)}}function sortListings(selector){var list=$(selector),listItem=$("article",list);listItem.sort(function(a,b){var keyA=$(a).find("h1").text(),keyB=$(b).find("h1").text();return keyA>keyB?1:0}),$.each(listItem,function(index,row){list.append(row)})}function normalize(string){return string.trim().toLowerCase()}function slugify(string){return string.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}function decode_string(string){var temp=document.createElement("textarea");return temp.innerHTML=string,temp.value}function getUniqueFeatures(array,comparatorProperty){var existingFeatureKeys={},uniqueFeatures=array.filter(function(el){return existingFeatureKeys[el.properties[comparatorProperty]]?!1:(existingFeatureKeys[el.properties[comparatorProperty]]=!0,!0)});return uniqueFeatures}var mapboxgl_api="https://api.mapbox.com",mapboxgl_username="abtadmin",mapboxgl_dataSetID_points="cj3nrirst001a33mrz90nj1qu",mapboxgl_dataSetID_region="ciyz3f02j02rm33moqf1vwepz";mapboxgl.accessToken="pk.eyJ1IjoiYWJ0YWRtaW4iLCJhIjoid3lQS0RvQSJ9.7Y3yjdxUbLyuMfmLOo7o-w";var mapboxgl_data_url=mapboxgl_api+"/datasets/v1/"+mapboxgl_username+"/"+mapboxgl_dataSetID_points+"/features?access_token="+mapboxgl.accessToken,mapboxgl_region_url=mapboxgl_api+"/datasets/v1/"+mapboxgl_username+"/"+mapboxgl_dataSetID_region+"/features?access_token="+mapboxgl.accessToken,map=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/light-v9",center:[-78.864,35.905],zoom:12,minZoom:8,attributionControl:!1}),mapbox_data,mapbox_layers=[],locations=[],popup=new mapboxgl.Popup({closeButton:!1}),filterGroup=document.getElementById("filter-group"),filterEl=document.getElementById("feature-filter"),listingEl=document.getElementById("feature-listing");map.on("load",function(){map.addControl(new mapboxgl.NavigationControl,"bottom-right"),map.addSource("points",{type:"geojson",data:mapboxgl_data_url}),map.addSource("rtp_outline",{type:"geojson",data:mapboxgl_region_url}),map.addLayer({id:"rtp_outline",type:"fill",source:"rtp_outline",paint:{"fill-color":"#517FA4","fill-opacity":.15}}),$.getJSON(mapboxgl_data_url,function(data){mapbox_data=data,mapbox_data.features.forEach(function(feature){var label,category=feature.properties.category,subcategory=feature.properties.subcategory,layer_id=category&&subcategory?"poi-"+slugify(subcategory):"poi-"+slugify(category),filter_by=category&&subcategory?"subcategory":"category",filter_val=category&&subcategory?subcategory:category;if("partner"!=category||subcategory?"amenity"!=category||subcategory?"site"!=category||subcategory?"space"!=category||subcategory?subcategory&&(label=subcategory):label="Available Spaces":label="Available Sites":label="Recreation & Amenities":label="Business / Organization",!map.getLayer(layer_id)&&(map.addLayer({id:layer_id,type:"circle",source:"points",paint:{"circle-radius":{base:1.75,stops:[[12,4],[22,180]]},"circle-color":{property:"category",type:"categorical",stops:[["partner","#194685"],["amenity","#00ACED"],["site","#EF4E22"],["space","#2EBAA5"]]}},filter:["==",filter_by,filter_val]}),category||category&&subcategory)){mapbox_layers.push(layer_id);var link=document.createElement("div");link.className="active",link.setAttribute("data-layer",layer_id),link.innerHTML='<a href="#">'+label+"</a>",subcategory&&link.setAttribute("data-parent","poi-"+slugify(category)),link.addEventListener("click",function(e){var clickedLayer=this.getAttribute("data-layer");e.preventDefault(),e.stopPropagation();var visibility=map.getLayoutProperty(clickedLayer,"visibility");"visible"===visibility?(map.setLayoutProperty(clickedLayer,"visibility","none"),this.className=""):(this.className="active",map.setLayoutProperty(clickedLayer,"visibility","visible"))});var layers=document.getElementById("map-menu");layers.appendChild(link)}}),mapbox_layers.forEach(function(layer){map.setLayoutProperty(layer,"visibility","visible")});var map_menu=document.getElementById("map-menu"),subcategories=document.querySelectorAll("#map-menu > div[data-parent]");subcategories.forEach(function(subcategory){var parent_id=subcategory.getAttribute("data-parent");if(parent=map_menu.querySelector('[data-layer="'+parent_id+'"]'),null==parent){"poi-partner"==parent_id&&(label="Business / Organization"),link=document.createElement("div"),link.className="active",link.setAttribute("data-layer",parent_id),link.innerHTML='<a href="#">'+label+"</a>",link.addEventListener("click",function(e){var toggleState;this.getAttribute("data-layer");e.preventDefault(),e.stopPropagation(),"active"==this.className?(this.className="",toggleState="off"):(this.className="active",toggleState="on"),subcategories.forEach(function(subcategory){var subcategory_parent_id=subcategory.getAttribute("data-parent");if(subcategory_parent_id==parent_id){var subcategory_layer=subcategory.getAttribute("data-layer");"off"==toggleState?(map.setLayoutProperty(subcategory_layer,"visibility","none"),subcategory.className=""):(subcategory.className="active",map.setLayoutProperty(subcategory_layer,"visibility","visible"))}})});var layers=document.getElementById("map-menu");layers.appendChild(link),parent=link}parent.appendChild(subcategory)});var children=document.querySelectorAll("#map-menu div[data-parent]"),childrenArray=[].slice.call(children).sort(function(a,b){return a.textContent>b.textContent?1:-1});childrenArray.forEach(function(child){var parent=child.getAttribute("data-parent");parent=map_menu.querySelector('[data-layer="'+parent+'"]'),parent.appendChild(child)})}),$("#loading").fadeOut()}),map.on("mousemove",function(e){var features=map.queryRenderedFeatures(e.point,{layers:mapbox_layers});if(!features.length)return void popup.remove();map.getCanvas().style.cursor=features.length?"pointer":"";var feature=features[0];popup.setLngLat(feature.geometry.coordinates).setText(feature.properties.title).addTo(map)}),map.on("moveend",function(){var features=map.queryRenderedFeatures({layers:mapbox_layers});if(features){var uniqueFeatures=getUniqueFeatures(features,"title");filterEl.disabled=!1,renderListings(uniqueFeatures);var listingsCount=$("#feature-listing article").not(".empty").length;$("#feature-count").addClass("active").html("<strong>"+listingsCount+"</strong> locations found"),0===filterEl.value.length&&(locations=uniqueFeatures)}}),map.on("click",function(e){var features=map.queryRenderedFeatures(e.point,{layers:mapbox_layers});if(features.length){map.flyTo({center:features[0].geometry.coordinates});var html="";features.length>1&&(html+='<div class="mapboxgl-popup-controls"><button id="control-prev" class="control-prev">Prev</button><button id="control-next" class="control-next">Next</button></div>',html+='<div class="control-group">'),features.forEach(function(feature){var property=feature.properties,thumbnail=property.thumbnail?'<div class="marker-photo"><img src="'+property.thumbnail+'" /></div>':"",title=property.title?property.title:"",permalink=property.permalink?'<div class="marker-action"><a class="button secondary" href="'+property.permalink+'" target="_blank">View Details</a></div>':"",category=property.category?property.category:"",subcategory=property.subcategory?'<div class="marker-category">'+property.subcategory+"</div>":"",site_num=property.site_number?'<div class="marker-site-number">Site '+property.site_number+"</div>":"",acres=property.acres?'<div class="marker-acres">'+property.acres+" acres</div>":"",space_type=property.space_type?'<div class="marker-space">'+property.space_type+"</div>":"",sqft=property.sqft?'<div class="marker-sqft">'+property.sqft+" sqft</div>":"",address1=property.address1?property.address1:"",address2=property.address2?property.address2:"",city="Research Triangle Park",state="NC",zipcode="27709";title=title&&permalink?'<div class="marker-title"><a href="'+property.permalink+'" target="_blank">'+property.title+"</a></div>":title?'<div class="marker-title">'+property.title+"</div>":"",address1&&address2?address='<div class="marker-address">'+address1+"<br />"+address2+"<br />"+city+" "+state+", "+zipcode+"</div>":address1?address='<div class="marker-address">'+address1+"<br />"+city+" "+state+", "+zipcode+"</div>":address="",html+="site"==category?'<div class="location '+property.category+'">'+thumbnail+subcategory+title+site_num+acres+permalink+"</div>":"space"==category?'<div class="location '+property.category+'">'+thumbnail+subcategory+title+space_type+sqft+permalink+"</div>":'<div class="location '+property.category+'">'+thumbnail+subcategory+title+address+permalink+"</div>"}),features.length>1&&(html+="</div>");(new mapboxgl.Popup).setLngLat(features[0].geometry.coordinates).setHTML(html).addTo(map);if(features.length>1){var locations=document.querySelectorAll(".control-group .location"),prevLocation=document.getElementById("control-prev"),nextLocation=document.getElementById("control-next");locations[0].classList.add("active"),prevLocation.addEventListener("click",function(){var group=document.querySelector(".control-group"),active=group.querySelector(".location.active"),previous=active.previousSibling?active.previousSibling:group.lastChild;active.classList.remove("active"),previous.classList.add("active")}),nextLocation.addEventListener("click",function(){var group=document.querySelector(".control-group"),active=document.querySelector(".control-group .location.active"),next=active.nextSibling?active.nextSibling:group.firstChild;active.classList.remove("active"),next.classList.add("active")})}}}),filterEl.addEventListener("keyup",function(e){var value=normalize(e.target.value),filtered=locations.filter(function(feature){var name=normalize(feature.properties.title),address=normalize(feature.properties.address1);return name.indexOf(value)>-1||address.indexOf(value)>-1});popup.remove(),renderListings(filtered);var listingsCount=$("#feature-listing article").not(".empty").length;$("#feature-count").addClass("active").html("<strong>"+listingsCount+"</strong> locations found"),mapbox_layers.forEach(function(layer){map.setFilter(layer,["in","title"].concat(filtered.map(function(feature){return feature.properties.title})))})}),renderListings([]);